# ZooKeeper基础知识
## ZooKeeper是什么
ZooKeeper在软件世界里就是一名管理者，它被用来提供分布式环境下的协调服务。

ZooKeeper是一个经典的分布式数据一致性解决方案，分布式应用程序可以基于它实现数据发布与订阅、负载均衡、命名服务、分布式协调与通知、集群管理、领导选举、分布式锁、分布式队列等功能。

ZooKeeper一般都以集群的方式对外提供服务，一个集群包含多个节点，每个节点都对应一台ZooKeeper服务器，所有的节点共同对外提供服务。整个集群环境对分布式数据一致性提供了全面的支持，具体包括以下五大特性。

1）顺序性。从同一个客户端发送的请求，最终将会严格按照其发送顺序进入ZooKeeper中。可见。这就像一个队列，拥有“先进先出”的特性，也就确保了请求的顺序性。

2）原子性。所有请求的相应结果在整个分布式集群环境中具备原子性，也就是说，要么整个集群中所有机器都成功地处理了某一个请求，要么就都没有处理，绝对不会出现集群中一部分机器处理了某一个请求，而另一部分机器却没有处理的情况，这方面的要求与事务的原子性是一样的。

3）一致性。无论客户端连接到哪个ZooKeeper服务器，每个客户端所看到的服务端数据模型都是一致的，不可能出现两种不同的数据状态。实际上每台ZooKeeper服务器之间是会进行数据同步的，而这个同步过程是相当高效地。

4）可靠性。一旦服务端数据状态发生了变化，就会立即存储起来，除非此时有另一个请求对其进行了变更，否则数据一定是可靠的。

5）实时性。当某个请求被成功处理后，客户端能够立即获取服务端的最新数据状态，整个过程具备实时性。

## ZooKeeper树状模型
ZooKeeper内部拥有一个树状的内存模型，类似于文件系统，有若干个目录，每个目录中也有若干个文件，只是在ZooKeeper中将这些目录与文件统称为ZNode，每个ZNode有对应的路径及其包含的数据。ZNode可由ZooKeeper客户端来创建，当客户端与服务端建立连接后，服务端将为客户端创建一个Session（会话），客户端对ZNode的所有操作均在这个会话中来完成。

ZNode有四类节点，分别是持久节点、临时节点、持久顺序节点和临时顺序节点。其中，持久节点在会话结束后不会被删除，而临时节点会；顺序节点的节点名中带自增数后缀。

ZooKeeper使用这个基于内存的树状模型来存储分布式数据，正是因为将所有数据都存放在内存中，所以才能实现高性能的目的，提高吞吐率。另外，这个树状模型还有助于集群环境下的数据同步。

## ZooKeeper集群结构
ZooKeeper并非采用经典的分布式一致性协议Paxos，而是参考了Paxos协议，设计了一款更加轻量级的协议，名为Zab（ZooKeeper Atomic Broadcast，ZooKeeper原子广播协议）。Zab协议分为两个阶段，Leader Election（领导选举）与Atomic Broadcast（原子广播）。

当ZooKeeper集群启动时，将会选举出一台节点为Leader（领导），而其他节点均为Follower（追随者）。当Leader节点出现故障时，会自动选举出新的Leader节点，并让所有节点恢复到一个正常的状态，这就是领导选举阶段。

进入原子广播阶段，该阶段将同步Leader节点与各个Follower节点之间的数据，确保Leader节点与Folloer节点具有相同的状态。所有的写操作都会发送到Leader节点，并通过广播的方式将数据同步到其他Follower节点。

一个ZooKeeper集群通常由一组节点组成，在一般情况下，3到5个节点就可以组成一个可用的ZooKeeper集群，理论上，节点越多越好。

组成ZooKeeper集群的每个节点都会在内存中维护当前的服务器状态，并且每个节点之间都会互相保持通信，目的就是告诉其他节点“自己还活着”。需要注意的是，只要集群中存在“超过半数以上”的节点可以正常工作，那么整个集群就能正常对外提供服务。因此，我们一般提供奇数个节点，比较节省资源。此外，ZooKeeper客户端可选择集群中任意一个节点来建立连接，而一旦客户端与某个节点之间断开连接，客户端会自动连接到集群中的其他节点。

## ZooKeeper重要配置项
tickTime=2000; initLimit=10; syncLimit=5; dataDir=/tmp/zookeeper; clientPort=2181

tickTime：称为“嘀嗒时间”，用于配置ZooKeeper中最小时间单元的长度，实际上ZooKeeper中很多运行时的时间间隔都是使用tickTime的倍数来表示的。例如ZooKeeper中会话的最小超时时间默认为2倍的tickTime。该配置的默认值为3000，单位为毫秒

initLimit：用于配置Leader节点等待Follower节点启动并完成数据同步的时间。Follower节点在启动过程中会与Leader节点建立连接并完成对数据的同步，从而确定自己对外提供服务的起始状态，Leader节点允许Follower节点在initLimit时间内完成这个工作。该配置的默认值是10，通常情况下，默认值即可。如果随着ZooKeeper集群管理的数据量不断增大，Follower节点在启动的时候，从Leader节点上进行数据同步的时间也会相应变长，于是无法在较短的时间内完成数据同步，在这种情况下，有必要适当调大这个参数。

syncLimit：用于配置Leader节点和Follower节点之间进行“心跳检测”的最大延时时间。在ZooKeeper集群运行过程中，Leader节点会与所有Follower节点进行心跳检测来确定该节点是否存活。如果Leader节点在syncLimit时间内无法获取Follower节点的心跳检测响应，那么Leader节点就会认为该Follower节点已经脱离了与自己的同步。默认值为5.

dataDir：用于配置ZooKeeper服务器存储快照文件的目录，不建议将其指定到/tmp目录下，因为该目录下的文件可能被自动删除。在ZooKeeper集群环境中，将生成一个名为myid的文件，该文件用于存放ZooKeeper集群节点的ID，我们需保证在整个集群环境中，整个ID是唯一的。

clientPort：用于配置当前ZooKeeper服务器对外暴露的端口，客户端会通过该端口在ZooKeeper服务器上建立连接并创建会话，一般设置为2181.每台ZooKeeper服务器都可以配置任意可用的端口，实际上，集群中的所有服务器也无须使用相同的clientPort。

## 作为Dubbo服务的注册中心
#### 流程说明
1）服务提供者启动时：会向/dubbo/{服务名}/providers目录下写入自己的URL地址
2）服务消费者启动时：订阅/dubbo/{服务名}/providers目录下的提供者URL地址，并向/dubbo/{服务名}/consumers目录写入自己的URL地址
3）监控中心启动时：订阅/dubbo/{服务名}目录下的所有提供者和消费者URL地址
#### 支持以下功能
A.当提供者出现断电等异常停机时，注册中心能自动删除提供者信息
B.当注册中心重启时，能自动恢复注册数据，以及订阅请求
C.当会话过期时，能自动恢复注册数据，以及订阅请求 







