# Nginx简略认识
## 1. Nginx是什么
Web服务器的基本功能：基于REST架构风格，以统一资源描述符（URI）或者统一资源定位符（URL）作为沟通依据，通过HTTP为浏览器等客户端程序提供各种网络服务。

对于高效处理大规模并发连接，它支持Linux上的epoll。epoll是Linux上处理大并发网络连接的利器）。

对于Linux，Nginx支持其独有的sendfile系统调用，这个系统调用可以高效地把硬盘中的数据发送到网络上（不需要先把硬盘数据复制到用户态内存上再发送），这极大地减少了内核态与用户态数据间的复制动作。

## 2.为什么选择Nginx
更快。一方面，在正常情况下，单次请求会得到更快的响应；另一方面，在高峰期（如数以万计的并发请求），Nginx可以比其他web服务器更快地响应请求。

高扩展性。Nginx的设计极具扩展性，它完全是由多个不同功能、不同层次、不同类型且耦合度极低的模块组成。

高可靠性。每个worker进程相对独立，master进程在1个worker进程出错时可以快速“拉起”新的worker子进程提供服务。

低内存消耗。一般情况下，10000个非活跃的HTTP Keep-Alive连接在Nginx中仅消耗2.5MB的内存，这是Nginx支持高并发连接的基础。

单机支持10万以上的并发连接。理论上，Nginx支持的并发连接上限取决于内存，10万远未封顶。

热部署。master管理进程与worker工作进程的分离设计，使得Nginx能够提供热部署功能，即可以在7x24小时不间断服务的前提下，升级Nginx的可执行文件。当然，它也支持不停止服务就更新配置项、更换日志文件等功能。

## 3.准备工作
部署目录。该目录存放实际Nginx服务运行期间所需要的二进制文件、配置文件等。默认情况下，该目录为/usr/local/nginx。

Linux内核参数的优化。由于默认的Linux内核参数考虑的是最通用的场景，这明显不符合用于支持高并发访问的web服务器的定义，所以需要修改Linux内核参数，使得Nginx可以拥有更高的性能。

我们会通过业务特点来进行调整，当Nginx作为静态web内容服务器、反向代理服务器或是提供图片缩略图功能（实时压缩图片）的服务器时，其内核参数的调整都是不同的。

file-max：这个参数表示进程（比如一个worker进程）可以同时打开的最大句柄数，这个参数直接限制最大并发连接数，需根据实际情况配置。

tcp\_max\_syn \_backlog：这个参数表示TCP三次握手建立阶段接收SYN请求队列的最大长度，默认为1024，将其设置得大一些可以使出现Nginx繁忙来不及accept新连接的情况时，Linux不至于丢失客户端发起的连接请求。

## 4.运行中的Nginx进程间的关系
在正式提供服务的产品环境下，部署Nginx时都是使用一个master进程来管理多个worker进程，一般情况下，worker进程的数量与服务器上的CPU核心数相等。每一个worker进程都是繁忙的，它们在真正地提供互联网服务，master进程则很“清闲”，只负责监控管理worker进程。worker进程之间通过共享内存、原子操作等一些进程间通信机制来实现负载均衡等功能。

Nginx是支持单进程（master进程）提供服务的，那么为什么产品环境下要按照master-worker方式配置同时启动多个进程呢？这样做的好处有以下两点：

第一点：由于master进程不会对用户请求提供服务，只用于管理真正提供服务的worker进程，所以master进程可以是唯一的，它仅专注于自己的纯管理工作，为管理员提供命令行服务，包括诸如启动服务、停止服务、重载配置文件、平滑升级程序等。

第二点：多个worker进程处理互联网请求不但可以提高服务的健壮性（一个worker进程出错后，其他worker进程仍然可以正常提供服务），最重要的是，这样可以充分利用现在常见的SMP多核架构。

在架构设计上，不同的worker进程之间处理并发请求时几乎没有同步锁的限制，worker进程通常不会进入睡眠状态，因此，当Nginx上的进程数与cpu核心数相等时（最好每一个worker进程都绑定特定的cpu核心），进程间切换的代价是最小的。

## 5.用HTTP核心模块配置一个静态web服务器
静态web服务器的主要功能由ngx\_http \_core \_module模块（HTTP框架的主要成员）实现，当然，一个完整的静态web服务器还有许多功能是由其他的HTTP模块实现的。

## 6.用HTTP proxy module配置一个反向代理服务器
反向代理（reverse proxy）方式是指用代理服务器来接受Internet上的连接请求，然后将请求转发给内部网络中的上游服务器，并将上游服务器上得到的结果返回给Internet上请求连接的客户端，此时代理服务器对外的表现就是一个web服务器。

由于Nginx具有“强悍”的高并发高负载能力，因此一般会作为前端的服务器直接向客户端提供静态文件服务。但也有一些复杂、多变的业务不适合放到Nginx服务器上，这时会用Apache、Tomcat等服务器来处理。于是，Nginx通常会被配置为既是静态web服务器也是反向代理服务器，不适合Nginx处理请求就会直接转发到上游服务器中处理。

当客户端发来HTTP请求时，Nginx并不会立刻转发到上游服务器，而是先把用户的请求（包括HTTP包体）完整地接收到Nginx所在服务器的硬盘或者内存中，然后再向上游服务器发起连接，把缓存的客户端请求转发到上游服务器。

很明显，缺点是延长了一个请求的处理时间，并增加了用于缓存请求内容的内存和磁盘空间。而优点则是降低了上游服务器的负载，尽量把压力放在Nginx服务器上。

Nginx在接收到完整的客户端请求（如1GB的文件）后，才会与上游服务器建立连接转发请求，由于是内网，所以这个转发过程会执行得很快。这样，一个客户端请求占用上游服务器的连接时间就会非常短，也就是说，Nginx的这种反向代理方案主要是为了降低上游服务器的并发压力。

在有些场景下，我们可能会希望来自某一个用户的请求始终落到固定的一台上游服务器中。例如，假设上游服务器会缓存一些信息。ip\_hash就是用以解决上述问题的，它首先根据客户端的ip地址计算出一个key，将key按照upstream集群里的上游服务器数量进行取模，然后以取模后的结果把请求转发到相应的上游服务器中。这样就确保了同一个客户端的请求只会转发到指定的上游服务器中。

ip\_hash与weight（权重）配置不可同时使用。如果upstream集群中有一台上游服务器暂时不可用，不能直接删除该配置，而是要down参数标识，确保转发策略的一贯性。









