# 数据库优化
## 优化SQL语句的一般步骤
先通过show status命令了解各种SQL的执行频率，了解大概的情况，找出问题方向；再通过慢查询日志或show processlist命令查看线程，定位执行效率较低的SQL语句；然后通过EXPLAIN分析低效SQL的执行计划，找出优化策略；最后可能要结合show profile分析命令查看线程各个状态的情况，进一步进行优化。
#### 1. 通过show status命令了解各种SQL的执行频率
Show status命令。Com\_xxx表示每个xxx语句执行的次数，例如Com\_select和增删改等等，这是对所有存储引擎的表操作进行统计的。InnoDB\_xxx针对的是InnoDB。

Com\_commit和Com\_rollback，对于回滚操作特别频繁的数据库，可能意味着应用编写存在问题。Connections，试图连接MySQL服务器的次数；Uptime，服务器工作时间；Slow\_queries，慢查询的次数。

#### 2.定位执行效率较低的SQL语句
第一种方法：通过慢查询日志定位。用—log-slow-queries[=file\_name]选项启动时，mysqld写一个包含所有执行时间超过long\_query\_time秒的SQL语句的日志文件。

第二种方法：慢查询日志在查询结束以后才记录，所以在应用反应执行效率出现问题的时候查询慢查询日志并不能定位问题。可以使用show processlist命令查看当前MySQL在进行的线程，包括线程的状态、是否锁表等，可以实时地查看SQL的执行情况，同时对一些锁表操作进行优化。

#### 3.通过EXPLAIN分析低效SQL的执行计划
可以通过EXPLAIN或者DESC命令获取MySQL如何执行SELECT语句的信息，包括在SELECT语句执行过程中表如何连接和连接的顺序。结果当中，会把结果集获取详情显示出来，下面是几个重要参数。

select\_type：表示SELECT的类型，常见的取值有SIMPLE（简单表，即不适用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、SUBQUERY（子查询中的第一个SELECT）等。

table：输出结果集的表。

Type：表示MySQL在表中找到所需行的方式，或者叫访问类型。常见的类型有:ALL，全表扫描；index，索引全扫描；range,索引范围扫描;ref，使用非唯一索引扫描或唯一扫描的前缀扫描，返回匹配某个单独值的记录;eq\_ref,类似ref，区别在于使用的索引是唯一索引;const,system,单表中最多有一个匹配行，查询起来非常迅速，所以这个匹配行的其他列的值可以被优化器在当前查询中当作常量来处理;NULL,不用访问表或索引，直接就能够得到结果;

Extra：是否使用了临时表，是否使用Filesort。

#### 4.通过show profile分析SQL
MySQL从5.0.37版本开始增加了对show profiles和show profile语句的支持。通过have\_profiling参数，能够看到当前MySQL是否支持profile。默认profiling是关闭的，可以通过set语句在Session级别开启profiling。

通过profile，我们能够更清楚地了解SQL执行得过程。先通过show profiles语句，找到所要查询的SQL的Query ID；再通过show profile for query语句，能够看到执行过程中线程的每个状态和消耗的时间。

常见的状态有，starting、Opening tables、System lock、executing、Sending data、end。尤其是Sending data，表示MySQL线程开始访问数据行并把结果返回给客户端，而不仅仅是返回结果给客户端；由于往往需要做大量的磁盘读取操作，所以经常是整个查询中耗时最长的状态。

还可以通过trace分析优化器如何选择执行计划。

#### 5.performance schema性能分析
5.7之后，逐渐拿performance schema取代show profile

第一步：SHOW VARIABLES LIKE 'performance\_schema'

## 索引问题
索引是数据库优化中最常用也是最重要的手段之一，通过索引通常可以帮助用户解决大多数的SQL性能问题。

#### 1.索引的存储分类
索引是在MySQL的存储引擎层中实现的，而不是在服务器层实现的。所以每种存储引擎的索引都不一定完全相同，也不是所有的存储引擎都支持所有的索引类型。

B树索引：最常见的索引类型，大部分引擎都支持。

HASH索引：只有Memory和Heap引擎支持，只有在“=”条件下才会使用索引。

Full-text（全文索引）：MyISAM的一个特殊索引类型，主要用于全文索引，InnoDB从MySQL5.6版本开始提供对全文索引的支持。

#### 2.B+树的特点
## 3.两个简单实用的优化方法
对于大多数开发人员来说，可能只希望掌握一些简单实用的优化方法，对于更多更复杂的优化，更倾向于交给专业DBA来做。

方法一：定期分析表和检查表。ANALYZE TABLE [tbl\_name]，用于分析和存储表的关键字分部，分析的结果可以使得系统得到准确的统计信息，使得SQL能够生成正确的执行计划。如果用户感觉实际执行计划并不是预期的执行计划，执行一次分析表可能会解决问题。CHECK TABLE，用于检查一个或多个表是否有错误。

方法二：定期优化表。OPTIMIZE TABLE [tbl\_name]，如果已经删除了表的一大部分，或者如果已经对含有可变长度行的表（含有VARCHAR、BLOB或TEXT列的表）进行了很多更改，可以用OPTIMIZE TABLE命令来进行表优化。这个命令可以将表中的空间碎片进行合并，并且可以消除由于删除或者更新造成的空间浪费。

这些命令执行期间会对表进行锁定，因此一定要注意在数据库不繁忙的时候执行相关的操作。

## 4.常用SQL的优化
#### 1.大批量插入数据
在大批量插入数据的时候，对于MyISAM存储引擎的表，可以通过先关闭再打开MyISAM表非唯一索引的更新的手段，提高导入的速度。

对于InnoDB，（1）由于InnoDB类型的表是按照主键的顺序保存的，所以将导入的数据按照主键的顺序排列，可以有效地提高导入数据的效率。（2）先关闭唯一性校验UNIQUE\_CHECKS，导入后，再打开。（3）先关闭自动提交AUTOCOMMIT，导入后，再打开。

#### 2.优化INSERT语句
方法一：如果同时从同一客户插入很多行，应尽量使用多个直表的INSERT语句，可以大大缩减客户端与数据之间的连接、关闭等消耗。

方法二：将索引文件和数据文件分在不同的磁盘上存放（利用建表中的选项）。

#### 3.优化ORDER BY语句
MySQL中有两种排序方式：第一种通过有序索引顺序扫描直接返回有序数据，这种方式在使用explain分析查询的时候显示为Using Index，不需要额外的排序，操作效率较高；第二种是通过返回数据进行排序，也就是通常说的Filesort排序，所有不是通过索引直接返回排序结果的排序都叫Filesort排序（可能会使用磁盘文件或临时表）。

Filesort是通过相应的排序算法，将取得的数据在sort\_buffer\_size系统变量设置的内存排序区中进行排序，如果内存装在不下，它就会将磁盘上的数据进行分块，再对各个数据块进行排序，然后将各个块合并成有序的结果集。

了解了MySQL排序的方式，优化目标就清晰了：尽量减少额外的排序，通过索引直接返回有序数据。WHERE条件和ORDER BY使用相同的索引，并且ORDER BY的顺序和索引顺序相同，并且ORDER BY的字段都是升序或者都是降序。否则肯定需要额外的排序操作，这样就会出现Filesort。

如果无法避免Filesort，那就适当加大系统变量max\_length\_sort\_data的值，以及尽量只使用必要的字段，SELECT具体的字段名称，而不是SELECT \*选择所有字段，这样就可以减少排序区的使用，提高SQL性能。

#### 4.优化GROUP BY语句
默认情况下，MySQL对所有GROUP BY col1,col2,···的字段进行排序。这与在查询中指定ORDER BY col1,col2,···类似。如果查询包括GROUP BY但用户想要避免排序结果的消耗，则可以指定ORDER BY NULL禁止排序，可以避免Filesort。

#### 5.优化嵌套查询
子查询可以一次性地完成很多逻辑上需要多个步骤才能完成的SQL操作，同时也可以避免事务或者表锁死，并且写起来也很容易。但是，有些情况下，子查询可以被更有效率的连接（JOIN）替代。

#### 6.优化OR条件
对于含有OR的查询子句，如果要利用索引，则OR之间的每个条件列都必须用到索引；如果没有索引，则应该考虑增加索引。

如果发现查询正确地用到了索引，并且从执行计划的描述中，发现MySQL在处理含有OR字句的查询时，实际是对OR的各个字段分别查询后的结果进行了UNION操作。在这里，两个独立的索引要比复合索引有用。

#### 7.优化分页查询
一般分页查询时，通过创建覆盖索引能够比较好地提高性能。一个常见又非常头痛的分页场景是“limit 1000,20”，此时MySQL排序出前1020条记录后仅仅需要返回第1001到1020条记录，前1000条记录都会被抛弃，查询和排序的代价非常高。

优化思路是，在索引上完成排序分页的操作，最后根据主键关联回原表查询所需要的其他列内容。

## 优化数据库对象
数据库如果设计不当，有可能会给将来的应用带来很多的性能问题。接下来将介绍MySQL中一些数据库对象的优化方法。

#### 1.优化表的数据类型
表需要使用何种数据类型是需要根据应用来判断的。虽然应用设计的时候需要考虑字段的长度留有一定的冗余，但是不推荐让很多字段都留有大量的冗余，这样既浪费磁盘存储空间，同时也让应用程序操作时浪费物理内存。

在MySQL中，可以使用函数PROCEDURE ANALYSE()对当前应用的表进行分析，该函数可以对数据表中列的数据类型提出优化建议。

#### 2.通过拆分提高表的访问效率
第一种方法是垂直拆分，即把主码和一些列放到一个表，然后把主码和另外的列放到另一个表中。缺点是如果要查询所有数据需要联合（JOIN）操作。

第二种方法是水平拆分，即根据一列或多列的值把数据行放到两个独立的表中。

#### 3.使用中间表提高统计查询速度
对于数据量较大的表，在其上进行统计查询通常会效率很低，并且还要考虑统计查询是否会对在线的应用产生负面影响。通常在这种情况下，使用中间表可以提高统计查询的效率。

优点一：中间表复制源表的部分数据，并且与源表相“隔离”，在中间表上做统计查询不会对在线应用产生负面影响；

优点二：中间表上可以灵活地添加索引或增加临时用的新字段，从而达到提高统计查询效率和辅助统计查询作用。