# 数据库优化
## 优化SQL语句的一般步骤
先通过show status命令了解各种SQL的执行频率，了解大概的情况，找出问题方向；再通过慢查询日志或show processlist命令查看线程，定位执行效率较低的SQL语句；然后通过EXPLAIN分析低效SQL的执行计划，找出优化策略；最后可能要结合show profile分析命令查看线程各个状态的情况，进一步进行优化。
#### 1. 通过show status命令了解各种SQL的执行频率
Show status命令。Com\_xxx表示每个xxx语句执行的次数，例如Com\_select和增删改等等，这是对所有存储引擎的表操作进行统计的。InnoDB\_xxx针对的是InnoDB。

Com\_commit和Com\_rollback，对于回滚操作特别频繁的数据库，可能意味着应用编写存在问题。Connections，试图连接MySQL服务器的次数；Uptime，服务器工作时间；Slow\_queries，慢查询的次数。

#### 2.定位执行效率较低的SQL语句
第一种方法：通过慢查询日志定位。用—log-slow-queries[=file\_name]选项启动时，mysqld写一个包含所有执行时间超过long\_query\_time秒的SQL语句的日志文件。

第二种方法：慢查询日志在查询结束以后才记录，所以在应用反应执行效率出现问题的时候查询慢查询日志并不能定位问题。可以使用show processlist命令查看当前MySQL在进行的线程，包括线程的状态、是否锁表等，可以实时地查看SQL的执行情况，同时对一些锁表操作进行优化。

#### 3.通过EXPLAIN分析低效SQL的执行计划
可以通过EXPLAIN或者DESC命令获取MySQL如何执行SELECT语句的信息，包括在SELECT语句执行过程中表如何连接和连接的顺序。结果当中，会把结果集获取详情显示出来，下面是几个重要参数。

select\_type：表示SELECT的类型，常见的取值有SIMPLE（简单表，即不适用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、SUBQUERY（子查询中的第一个SELECT）等。

table：输出结果集的表。

Type：表示MySQL在表中找到所需行的方式，或者叫访问类型。常见的类型有:ALL，全表扫描；index，索引全扫描；range,索引范围扫描;ref，使用非唯一索引扫描或唯一扫描的前缀扫描，返回匹配某个单独值的记录;eq\_ref,类似ref，区别在于使用的索引是唯一索引;const,system,单表中最多有一个匹配行，查询起来非常迅速，所以这个匹配行的其他列的值可以被优化器在当前查询中当作常量来处理;NULL,不用访问表或索引，直接就能够得到结果;

#### 4.通过show profile分析SQL
MySQL从5.0.37版本开始增加了对show profiles和show profile语句的支持。通过have\_profiling参数，能够看到当前MySQL是否支持profile。默认profiling是关闭的，可以通过set语句在Session级别开启profiling。

通过profile，我们能够更清楚地了解SQL执行得过程。先通过show profiles语句，找到所要查询的SQL的Query ID；再通过show profile for query语句，能够看到执行过程中线程的每个状态和消耗的时间。

常见的状态有，starting、Opening tables、System lock、executing、Sending data、end。尤其是Sending data，表示MySQL线程开始访问数据行并把结果返回给客户端，而不仅仅是返回结果给客户端；由于往往需要做大量的磁盘读取操作，所以经常是整个查询中耗时最长的状态。

还可以通过trace分析优化器如何选择执行计划。

## 索引问题
索引是数据库优化中最常用也是最重要的手段之一，通过索引通常可以帮助用户解决大多数的SQL性能问题。

#### 1.索引的存储分类
索引是在MySQL的存储引擎层中实现的，而不是在服务器层实现的。所以每种存储引擎的索引都不一定完全相同，也不是所有的存储引擎都支持所有的索引类型。

B树索引：最常见的索引类型，大部分引擎都支持。

HASH索引：只有Memory和Heap引擎支持，只有在“=”条件下才会使用索引。

Full-text（全文索引）：MyISAM的一个特殊索引类型，主要用于全文索引，InnoDB从MySQL5.6版本开始提供对全文索引的支持。

#### 2.B+树的特点
#### 3.两个简单实用的优化方法
对于大多数开发人员来说，可能只希望掌握一些简单实用的优化方法，对于更多更复杂的优化，更倾向于交给专业DBA来做。

方法一：定期分析表和检查表。ANALYZE TABLE [tbl\_name]，用于分析和存储表的关键字分部，分析的结果可以使得系统得到准确的统计信息，使得SQL能够生成正确的执行计划。如果用户感觉实际执行计划并不是预期的执行计划，执行一次分析表可能会解决问题。CHECK TABLE，用于检查一个或多个表是否有错误。

方法二：定期优化表。OPTIMIZE TABLE [tbl\_name]，如果已经删除了表的一大部分，或者如果已经对含有可变长度行的表（含有VARCHAR、BLOB或TEXT列的表）进行了很多更改，可以用OPTIMIZE TABLE命令来进行表优化。这个命令可以将表中的空间碎片进行合并，并且可以消除由于删除或者更新造成的空间浪费。

这些命令执行期间会对表进行锁定，因此一定要注意在数据库不繁忙的时候执行相关的操作。

#### 4.


